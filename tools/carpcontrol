#!/usr/local/bin/cbsd
#v10.1.6
globalconf="${workdir}/cbsd.conf";
MYARG=""
MYOPTARG="vhid advskew pass ip interface state"
MYDESC="Carp action collector"

set -e
. ${globalconf}
. ${workdir}/carp.subr
set +e

. ${subr}
. ${tools}
. ${initenv}
init $*

set -e
. ${workdir}/carp.subr
set +e

### MAIN
args="$*"
[ -z "${args}" ] && exit 0
echo "${args}" >> /tmp/cbsd_carp.log

/sbin/kldstat -qm carp || /sbin/kldload carp

eval $( echo "${args}" |/usr/bin/tr "@" " "|while read vhid interface state; do
	[ -z "${state}" ] && continue
	echo "export vhid=${vhid}"
	echo "export itnerface=${interface}"
	echo "export state=${state}"
done )

jname_list=$( get_jname_by_vhid ${vhid} )

[ -z "${jname_list}" ] && exit 0

echo "state $state for jail: ${jname}"

case "${state}" in
	[Bb][Aa][Cc][Kk][Uu][Pp])
		jstop inter=0 ${jname}
		;;
	[Mm][Aa][Ss][Tt][Ee][Rr])
		jstart inter=0 ${jname}
		;;
	*)
		err 1 "${MAGENTA}Unknown carp state: ${state}${NORMAL}"
		;;
esac

