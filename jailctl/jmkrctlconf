#!/usr/local/bin/cbsd
#v10.0.2
CBSDMODULE="jail"
MYARG="jname type mode file"
MYDESC="Import or export from/to ascii rctl.conf from/to SQLite3 tables for jail"
ADDHELP="type= rctl or extra\n\"
mode= tosql or to tofile\n\
file= ascii file\n"

. ${subr}
. ${sharedir}/rctl.conf
. ${workdir}/jrctl.subr
. ${tools}

init $*

header() {
cat >${file} <<EOF
# DO NOT EDIT THIS FILE. PLEASE USE INSTEAD:
# cbsd jrctl-tui jname=${jname}
EOF
}

tofile()
{
	truncate -s0 ${file}

	case "${type}" in
		"rctl")
			header
			for i in ${RCTL}; do
				VAL=$( cbsdsql local SELECT ${i} FROM rctl WHERE jname=\"${jname}\" )
				[ "${VAL}" = "(null)" -o -z "${VAL}" -o "${VAL}" = "0" ] && continue
				echo "${i}:deny=${VAL}" > ${file}
			done
			;;
		"extra")
			header
			for i in ${RCTL_EXTRA}; do
				VAL=$( cbsdsql local SELECT ${i} FROM rctl WHERE jname=\"${jname}\" )
				[ "${VAL}" = "(null)" -o -z "${VAL}" -o "${VAL}" = "0" ] && continue
				echo "${i}=${VAL}" > ${file}
			done
			;;
		*)
			err 1 "${MAGENTA}type= must be 'rctl' or 'extra'${NORMAL}"
			;;
	esac
}

tosql()
{
	local _myval _items _res
	_num=0

	[ ! -f "${file}" ] && err 1 "${MAGENTA}No such file: ${GREEN}${file}${NORMAL}"

	case "${type}" in
		"rctl")
			eval $( tr ":=" " " < ${file} | /usr/bin/awk -F " " '{printf("%s=\"%s\"\n", $1,$3); }' )
			;;
		"extra")
			eval $(cat ${file} )
			;;
	esac

	_res=$( cbsdsql local SELECT jname FROM rctl WHERE jname=\"${jname}\" )
	[ -z "${_res}" ] && cbsdsql local "INSERT INTO rctl ( jname ) VALUES ( \"${jname}\" )"

	case "${type}" in
		"rctl")
			for _items in ${RCTL}; do
				eval _myval=\$${_items}
				[ -z "${_myval}" ] && _myval="0"
				cbsdsql local UPDATE rctl SET ${_items}=\"${_myval}\" WHERE jname=\"${jname}\"
			done
			;;
		"extra")
			for _items in ${RCTL_EXTRA}; do
				eval _myval=\$${_items}
				[ -z "${_myval}"  ] && _myval="0"
				cbsdsql local UPDATE rctl SET ${_items}=\"${_myval}\" WHERE jname=\"${jname}\"
			done
			;;
	esac
}

# MAIN
case "${mode}" in
	"tofile")
		tofile
		;;
	"tosql")
		tosql
		;;
	*)
		err 1 "${MAGENTA}mode= must be 'tosql' or 'tofile'${NORMAL}"
		;;
esac

# exit code 0 is nessesary for dot()
exit 0
